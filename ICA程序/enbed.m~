clear all; close all;
A = imread('lena.jpg'); 
% A=OpenBitmap('6.tif');
k=32;
l=32;
S_CI=DvdBptSubBp(A,k,l); %split into patches
% normalise
% S_CI = normalize(S_CI);
% whitening
% S_CI = whiten(S_CI);
%-----------------------------------------------------------------
[icasig, A_matrix, W_matrix] =fastica(S_CI); %independent signals; mixing matrix; sepration matrix
% -----frequency spectrum ------
% figure;
% for i = 1:49
%     Fs = 2000;
%     t = 0:1/Fs:1-1/Fs;
%     N = length(icasig(i,:));
%     xdft = fft(icasig(i,:));
%     xdft = xdft(1:N/2+1);
%     psdx = (1/(Fs*N)) * abs(xdft).^2;
%     psdx(2:end-1) = 2*psdx(2:end-1);
%     freq = 0:Fs/length(icasig(i,:)):Fs/2;
%     hold on
%     plot(freq,10*log10(psdx));
% end
% hold off
% grid on
% title('Periodogram Using FFT')
% xlabel('Frequency (Hz)')
% ylabel('Power/Frequency (dB/Hz)')
% ------- histogram ---------------
% figure;
% histogram(A_matrix);
% A_matrix is 'ICA coefficients' which has super guassian distribution
% icasig is the basis funcions
% show all ica feature basis
% icasig(49,:)=0.001;
% A_matrix(:,49)=0.001;
% W_matrix(49,:)=0.001;
% figure;
% for i = 1:49
%     subplot(7,7,i);
%     imshow(reshape(icasig(i,:),64,64));
% end
%---Step1------------------------------------------------------------------
mark = imread('changsha.bmp');
B_CI=DvdBptSubBp(mark,k,l);
[ica_b,b_A,b_W] =fastica(B_CI);
mark_ = b_A*ica_b;
A_embedSubBPtBP(mark_,k,l,S_CI)
imshow(reshape(mark_b,64,64))
[out_b,index_b] = sort(cov(ica_b),2);
%--------------------------------------------------------------------------
r = 2;
alpha = 0.5;
[out,index] = sort(cov(icasig),2,'ascend');
Y_v = icasig;
for i = 1:r
    Y_v(225-i,:) =   alpha*ica_b(i,:);
end
S_CI=A_matrix*Y_v; % Remix the signals
A_embed = SubBPtBP(A,k,l,S_CI); % Restore watermarked image
figure;
imshow(A_embed);

S_CI_ = S_CI;
Y_v = W_matrix*S_CI_;
Y_w = zeros(4,1024);
for i = 1:r
    Y_w(i,:) = Y_v(225-i,:);
end
x_w = abs(b_A*Y_w);
imshow(reshape(abs(x_w),64,64))